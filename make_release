#!/bin/bash
# reads version from setup.py, create a source tarball and optionally
# upload to fedorahosted
#
# Options: -b  Batch mode, don't ask for fedorahosted upload
#          -q  Quick: disable test, implies -b.

startdir=$PWD
cd $( dirname $( readlink -fn $0 ))
branch=$( git branch | awk '/^*/ {print $2}' )
commit=$( git log --oneline | cut -d' ' -f1 )
echo "Using branch: $branch"
echo "Last commit : $(git log --oneline -1)"

status=$( git status --short -uno)
[ -n "$status" ] && echo 'Warning: there are uncommitted changes' >&2

echo
newdir=$( mktemp --tmpdir -d fedora-review-release-XXXXX )
git clone -b $branch . $newdir
cd $newdir

badlinks=$( find . -type l ! -execdir test -e '{}' \; -print | nl )
[ -n "$badlinks" ] && echo "Warning: unresolved  symlinks: $badlinks" >&2

./update-version

source src/FedoraReview/version
dfile="dist/fedora-review-$__version__.tar.gz"
[ -f ${dfile} ] && echo Removing: $dfile
rm -f $dfile

# setuptools does not package symlinks...
cd test; ./remember-links > restore-links.sh; cd $OLDPWD

env PYTHONPATH=src python setup.py --quiet clean
env PYTHONPATH=src python setup.py --quiet build sdist
if [ ! -e "$dfile" ];  then
    echo "Error: could not create $dfile"
    exit 1
fi
echo "Created: $dfile"

if [ ! "$1" = '-q' ]; then
    echo "Running tests on tarball before finalizing release"
    tar -xf $dfile && pushd fedora-review-$__version__
    cd test
    bash < restore-links.sh
    REVIEW_LOGLEVEL=error python -m unittest discover
    if [ $? -ne 0 ]; then
        echo "Some tests failed. Review test logs and fix all problems"
        echo "before doing a release."
        echo "Aborting. Temporary files left in $newdir"
        exit 1
    fi
fi


if [[ "$1" = '-b' || "$1" = '-q' ]]; then
    rm -rf $newdir
    exit
fi

cd $startdir
read -i 'n' -e -p "Do you want to upload file $dfile to fedorahosted? (y/n): "
if [ "$REPLY" = "y" ];then
    scp "${dfile}" fedorahosted.org:FedoraReview
    git tag $__version__
    git push --tags
    echo "Things to do now:"
    echo "      1. Merge to 'master' and 'devel'"
    echo "      2. Update trac releases and tickets"
    echo "      3. Build rpms for Fedoras/EPEL"
    echo "      4. Create updates in bodhi"
    echo "      5. Announce!"
    echo "      6. (nice to have) Update trac queries for new milestone"
fi
rm -rf $newdir
